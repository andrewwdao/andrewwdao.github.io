var Cango,Drag2D,svgToCgo2D,shapeDefs,_resized,_buf,_draggable,_overlays;!function(){var t,s=0,i=["webkit","moz"];for(t=0;t<i.length&&!window.requestAnimationFrame;++t)window.requestAnimationFrame=window[i[t]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[i[t]+"CancelAnimationFrame"]||window[i[t]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t){var i=(new Date).getTime(),e=Math.max(0,16-(i-s)),r=window.setTimeout(function(){t(i+e)},e);return s=i+e,r}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}(),function(){"use strict";function t(t,s){this.drawFn=t,this.parms=s||[],this.parmsPx=[]}function s(s,i){function e(t,s,i,e,r,o,a,h){var n=h*r,l=-a*o,c=a*r,d=h*o,p=.5*(e-i),m=8/3*Math.sin(.5*p)*Math.sin(.5*p)/Math.sin(p),f=t+Math.cos(i)-m*Math.sin(i),g=s+Math.sin(i)+m*Math.cos(i),u=t+Math.cos(e),C=s+Math.sin(e),x=u+m*Math.sin(e),w=C-m*Math.cos(e);return[n*f+l*g,c*f+d*g,n*x+l*w,c*x+d*w,n*u+l*C,c*u+d*C]}function r(t,s,i,r,o,a,h,n,l){var c,d,p,m,f,g,u,C,x,w,y,b,v,L,T,k,M,P,I,A,W,B=o*(Math.PI/180),_=Math.sin(B),S=Math.cos(B),D=Math.abs(i),E=Math.abs(r),H=[];for((p=(c=S*(t-n)*.5+_*(s-l)*.5)*c/(D*D)+(d=S*(s-l)*.5-_*(t-n)*.5)*d/(E*E))>1&&(D*=p=Math.sqrt(p),E*=p),(b=1/(((w=(m=S/D)*n+(f=_/D)*l)-(C=m*t+f*s))*(w-C)+((y=(g=-_/E)*n+(u=S/E)*l)-(x=g*t+u*s))*(y-x))-.25)<0&&(b=0),v=Math.sqrt(b),h==a&&(v=-v),L=.5*(C+w)-v*(y-x),T=.5*(x+y)+v*(w-C),k=Math.atan2(x-T,C-L),(M=Math.atan2(y-T,w-L)-k)<0&&1==h?M+=2*Math.PI:M>0&&0==h&&(M-=2*Math.PI),P=Math.ceil(Math.abs(M/(.5*Math.PI+.001))),I=0;I<P;I++)A=k+I*M/P,W=k+(I+1)*M/P,H.push(e(L,T,A,W,D,E,_,S));return H}var o,h,n,l,c,d,p,m,f,g,u=0,C=0,x=[],w=i||1,y=w,b=0,v=0,L=[];if(!a(s))return x;if("number"==typeof s[0]){L[0]=["M",s[0],s[1]];var T=["L"];for(g=2,f=2;f<s.length&&"number"==typeof s[f];f++);L[1]=T.concat(s.slice(g,f))}else{for(g=0,f=1;f<s.length;f++)"string"==typeof s[f]&&(L.push(s.slice(g,f)),g=f);L.push(s.slice(g,f))}for(f=0;f<L.length;f++){switch(l=(p=L[f])[0],0==f&&"M"!=l&&(l="M"),(m=p.slice(1))&&(m=m.map(parseFloat)),l){case"M":for(o=h=null,d=new t("moveTo",[u=b+w*m[0],C=v+y*m[1]]),x.push(d),m.splice(0,2);m.length>0;)d=new t("lineTo",[u=b+w*m[0],C=v+y*m[1]]),x.push(d),m.splice(0,2);break;case"m":for(o=h=null,d=new t("moveTo",[u+=w*m[0],C+=y*m[1]]),x.push(d),m.splice(0,2);m.length>0;)d=new t("lineTo",[u+=w*m[0],C+=y*m[1]]),x.push(d),m.splice(0,2);break;case"L":for(;m.length>0;)d=new t("lineTo",[u=b+w*m[0],C=v+y*m[1]]),x.push(d),m.splice(0,2);o=h=null;break;case"l":for(;m.length>0;)d=new t("lineTo",[u+=w*m[0],C+=y*m[1]]),x.push(d),m.splice(0,2);o=h=null;break;case"H":o=h=null,d=new t("lineTo",[u=b+w*m[0],C]),x.push(d);break;case"h":o=h=null,d=new t("lineTo",[u+=w*m[0],C]),x.push(d);break;case"V":o=h=null,d=new t("lineTo",[u,C=v+y*m[0]]),x.push(d);break;case"v":o=h=null,d=new t("lineTo",[u,C+=y*m[0]]),x.push(d);break;case"C":for(;m.length>0;)d=new t("bezierCurveTo",[b+w*m[0],v+y*m[1],o=b+w*m[2],h=v+y*m[3],u=b+w*m[4],C=v+y*m[5]]),x.push(d),m.splice(0,6);break;case"c":for(;m.length>0;)d=new t("bezierCurveTo",[u+w*m[0],C+y*m[1],o=u+w*m[2],h=C+y*m[3],u+=w*m[4],C+=y*m[5]]),x.push(d),m.splice(0,6);break;case"S":null!=o&&c.match(/[sc]/i)||(o=u,h=C),d=new t("bezierCurveTo",[u-(o-u),C-(h-C),b+w*m[0],v+y*m[1],b+w*m[2],v+y*m[3]]),x.push(d),o=b+w*m[0],h=v+y*m[1],u=b+w*m[2],C=v+y*m[3];break;case"s":null!=o&&c.match(/[sc]/i)||(o=u,h=C),d=new t("bezierCurveTo",[u-(o-u),C-(h-C),u+b+w*m[0],C+v+y*m[1],u+b+w*m[2],C+v+y*m[3]]),x.push(d),o=u+w*m[0],h=C+y*m[1],u+=w*m[2],C+=y*m[3];break;case"Q":d=new t("quadraticCurveTo",[o=b+w*m[0],h=v+y*m[1],u=b+w*m[2],C=v+y*m[3]]),x.push(d);break;case"q":d=new t("quadraticCurveTo",[u+w*m[0],C+y*m[1],u+w*m[2],C+y*m[3]]),x.push(d),o=u+w*m[0],h=C+y*m[1],u+=w*m[2],C+=y*m[3];break;case"T":null!=o&&c.match(/[qt]/i)?(o=u-(o-u),h=C-(h-C)):(o=u,h=C),d=new t("quadraticCurveTo",[o,h,b+w*m[0],v+y*m[1]]),x.push(d),o=u-(o-u),h=C-(h-C),u=b+w*m[0],C=v+y*m[1];break;case"t":null!=o&&c.match(/[qt]/i)?(o=u-(o-u),h=C-(h-C)):(o=u,h=C),d=new t("quadraticCurveTo",[o,h,u+w*m[0],C+y*m[1]]),x.push(d),u+=w*m[0],C+=y*m[1];break;case"A":for(;m.length>0;){for(n=r(o=u,h=C,w*m[0],w*m[1],-m[2],m[3],1-m[4],u=b+w*m[5],C=v+y*m[6]),g=0;g<n.length;g++)d=new t("bezierCurveTo",n[g]),x.push(d);m.splice(0,7)}break;case"a":for(;m.length>0;){for(n=r(o=u,h=C,w*m[0],w*m[1],-m[2],m[3],1-m[4],u+=w*m[5],C+=y*m[6]),g=0;g<n.length;g++)d=new t("bezierCurveTo",n[g]),x.push(d);m.splice(0,7)}break;case"Z":case"z":d=new t("closePath",[]),x.push(d)}c=l}return x}function i(t,s,i,e,r,o,a){this.cgo=t,this.type="SHAPE",this.drawCmds=s,this.bBoxCmds=[],this.dwgOrg={x:0,y:0},this.iso=!1,this.strokeCol="black",this.fillCol="gray",this.strokeWidth=1,this.strokeCap="butt",this.width=0,this.height=0,this.imgX=0,this.imgY=0,this.imgXscale=1,this.imgYscale=1,this.imgDegs=0,this.fontSize=10,this.fontWeight=400,this.lorg=a||1,this.dragNdrop=null,t&&(this.type=i||"SHAPE",this.iso=1==e,"IMG"!=this.type&&"TEXT"!=this.type||(this.iso=!0),r!==undefined&&null!=r?this.fillCol=r:this.fillCol=t.paintCol,o!==undefined&&null!=o?this.strokeCol=o:"SHAPE"==this.type?this.strokeCol=this.fillCol:this.strokeCol=t.penCol,this.strokeWidth=t.penWid,this.strokeCap=t.lineCap,"TEXT"==this.type&&(this.strokeCap="round"))}function e(t,s,i){var e,r,o;return a(t)?0==s?t[0]:s>=i?t[t.length-1]:(e=i/(t.length-1),o=(s-(r=Math.floor(s/e))*e)/e,t[r]+o*(t[r+1]-t[r])):t}function r(t,s,i,r,o,h,n,l){var c=this,d=s||0,p=i||0,m=r||1,f=o||0;this.getState=function(t,s){var i,r;0==t&&(c.startTime=0),(i=t-c.startTime)>c.dur+c.delay&&c.dur>0&&c.loop&&(c.startTime=t,i=0),r=0,i>c.delay&&(r=i-c.delay),a(d)?s.x=e(d,r,c.dur):s.x=d,a(p)?s.y=e(p,r,c.dur):s.y=p,a(m)?s.scl=e(m,r,c.dur):s.scl=m,a(f)?s.rot=e(f,r,c.dur):s.rot=f},this.delay=h||0,this.dur=n||0,this.loop=l||!1,this.startTime=0,this.obj=t}var o=0;Date.now||(Date.now=function(){return(new Date).getTime()});var a=function(t){return"[object Array]"===Object.prototype.toString.call(t)},h=function(t){return!isNaN(t)&&null!==t&&""!==t&&!1!==t},n=function(t,s){var i=t.onload;"function"!=typeof t.onload?t.onload=s:t.onload=function(){i(),s()}};Array.prototype.contains||(Array.prototype.contains=function(t){for(var s=this.length;s--;)if(this[s]===t)return!0;return!1}),"indexOf"in Array.prototype||(Array.prototype.indexOf=function(t,s){var i;for(s===undefined&&(s=0),s<0&&(s+=this.length),s<0&&(s=0),i=this.length;s<i;s++)if(s in this&&this[s]===t)return s;return-1}),Array.prototype.map||(Array.prototype.map=function(t,s){var i,e=this.length;if("function"!=typeof t)throw new TypeError;var r=[],o=s;for(i=0;i<e;i++)this.hasOwnProperty(i)&&(r[i]=t.call(o,this[i],i,this));return r}),"object"!=typeof _resized&&(_resized={}),"object"!=typeof _buf&&(_buf={}),"object"!=typeof _draggable&&(_draggable={}),"object"!=typeof _overlays&&(_overlays={}),shapeDefs===undefined&&(shapeDefs={circle:["M",-.5,0,"C",-.5,-.27614,-.27614,-.5,0,-.5,"C",.27614,-.5,.5,-.27614,.5,0,"C",.5,.27614,.27614,.5,0,.5,"C",-.27614,.5,-.5,.27614,-.5,0],square:["M",.5,-.5,"l",0,1,-1,0,0,-1,"z"],triangle:["M",.5,-.289,"l",-.5,.866,-.5,-.866,"z"],cross:["M",-.5,0,"l",1,0,"M",0,-.5,"l",0,1],ex:["M",-.3535,-.3535,"L",.3535,.3535,"M",-.3535,.3535,"L",.3535,-.3535]}),i.prototype.translate=function(t,s){var i,e,r;if("IMG"==this.type||"TEXT"==this.type)for(this.imgX+=t/this.cgo.xscl,this.imgY+=-s/this.cgo.yscl,r=0;r<this.bBoxCmds.length;r++)this.bBoxCmds[r].parms.length&&(this.bBoxCmds[r].parms[0]+=t,this.bBoxCmds[r].parms[1]+=s,this.bBoxCmds[r].parmsPx[0]=this.vpLLx+this.xoffset+this.bBoxCmds[r].parms[0]*this.cgo.xscl,this.bBoxCmds[r].parmsPx[1]=this.vpLLy+this.yoffset+this.bBoxCmds[r].parms[1]*this.cgo.xscl);else for(e=0;e<this.drawCmds.length;e++)for(i=this.drawCmds[e],r=0;r<i.parms.length/2;r++)i.parms[2*r]+=t,i.parms[2*r+1]+=s,i.parmsPx[2*r]=this.vpLLx+this.xoffset+i.parms[2*r]*this.cgo.xscl,i.parmsPx[2*r+1]=this.vpLLy+this.yoffset+i.parms[2*r+1]*this.cgo.xscl},i.prototype.rotate=function(t){var s,i,e,r,o,a=Math.PI*t/180,h=Math.sin(a),n=Math.cos(a);if("IMG"==this.type||"TEXT"==this.type)this.imgDegs+=t;else for(r=0;r<this.drawCmds.length;r++)for(s=this.drawCmds[r],o=0;o<s.parms.length/2;o++)i=s.parms[2*o],e=s.parms[2*o+1],s.parms[2*o]=i*n-e*h,s.parms[2*o+1]=i*h+e*n,s.parmsPx[2*o]=this.vpLLx+this.xoffset+s.parms[2*o]*this.cgo.xscl,s.parmsPx[2*o+1]=this.vpLLy+this.yoffset+s.parms[2*o+1]*this.cgo.xscl},i.prototype.scale=function(t,s){var i,e,r,o=t||1,a=s||o;if("IMG"==this.type||"TEXT"==this.type)for(this.imgXscale*=o,this.imgYscale*=a,this.imgX*=o,this.imgY*=a,r=0;r<this.bBoxCmds.length;r++)this.bBoxCmds[r].parms.length&&(this.bBoxCmds[r].parms[0]*=o,this.bBoxCmds[r].parms[1]*=a,this.bBoxCmds[r].parmsPx[0]=this.vpLLx+this.xoffset+this.bBoxCmds[r].parms[0]*this.cgo.xscl,this.bBoxCmds[r].parmsPx[1]=this.vpLLy+this.yoffset+this.bBoxCmds[r].parms[1]*this.cgo.xscl);else{for(e=0;e<this.drawCmds.length;e++)for(i=this.drawCmds[e],r=0;r<i.parms.length/2;r++)i.parms[2*r]*=o,i.parms[2*r+1]*=a,i.parmsPx[2*r]=this.vpLLx+this.xoffset+i.parms[2*r]*this.cgo.xscl,i.parmsPx[2*r+1]=this.vpLLy+this.yoffset+i.parms[2*r+1]*this.cgo.xscl;"PATH"==this.type&&(this.strokeWidth*=o)}},i.prototype.appendPath=function(t,s){"IMG"!=this.type&&"TEXT"!=this.type&&"IMG"!=t.type&&"TEXT"!=t.type&&(this.drawCmds=s?this.drawCmds.concat(t.drawCmds.slice(1)):this.drawCmds.concat(t.drawCmds))},i.prototype.revWinding=function(){function s(t){if(2==t.length)return t;var s,i,e=[];for(s=0,i=t.length/2-1;i>=0;s++,i--)e[2*s]=t[2*i],e[2*s+1]=t[2*i+1];return e}var i,e,r,o,a,h=null,n=[];if("IMG"!=this.type&&"TEXT"!=this.type){for("Z"==this.drawCmds[this.drawCmds.length-1].drawFn.toUpperCase()?(i=this.drawCmds.slice(0,-1),h=this.drawCmds.slice(-1)):i=this.drawCmds.slice(0),r=i[e=i.length-1].parms.length,a=new t("moveTo",o=[i[e].parms[r-2],i[e].parms[r-1]]),n.push(a),i[e].parms=i[e].parms.slice(0,-2);e>0;)o=s(i[e].parms),r=i[e-1].parms.length,o.push(i[e-1].parms[r-2],i[e-1].parms[r-1]),a=new t(i[e].drawFn,o),n.push(a),i[e-1].parms=i[e-1].parms.slice(0,-2),e--;h&&n.push(h),this.drawCmds=n}},i.prototype.enableDrag=function(t){this.dragNdrop=t,this.dragNdrop.parent=this,_draggable[t.cgo.cId].push(this)},i.prototype.disableDrag=function(){function t(t,s){var i,e;for(i=0,e=t.length;i<e;i++)if(t[i]===s)return i;return-1}var s;this.dragNdrop&&(s=t(_draggable[this.dragNdrop.cgo.cId],this),_draggable[this.dragNdrop.cgo.cId].splice(s,1),this.dragNdrop=null)},i.prototype.setProperty=function(t,s){if("string"==typeof t&&s!==undefined&&null!=s)switch(t.toLowerCase()){case"fillcolor":if("string"!=typeof s&&"object"!=typeof s)return;this.fillCol=s;break;case"strokecolor":if("string"!=typeof s&&"object"!=typeof s)return;this.strokeCol=s;break;case"strokewidth":this.strokeWidth=s;break;case"linecap":if("string"!=typeof s)return;"butt"!=s&&"round"!=s&&"square"!=s||(this.strokeCap=s);break;case"fontsize":this.fontSize=Math.abs(s);break;case"fontweight":("string"==typeof s||s>=100&&s<=900)&&(this.fontWeight=s);break;default:return}},i.prototype.dup=function(){function t(s){var i,e=a(s)?[]:{};for(i in s)s[i]&&"object"==typeof s[i]&&"cgo"!=i?e[i]=t(s[i]):e[i]=s[i];return e}var s=new i;return s.cgo=this.cgo,s.type=this.type,s.drawCmds=t(this.drawCmds),s.bBoxCmds=t(this.bBoxCmds),s.dwgOrg=t(this.dwgOrg),s.iso=this.iso,s.strokeCol=this.strokeCol,s.fillCol=this.fillCol,s.strokeWidth=this.strokeWidth,s.strokeCap=this.strokeCap,s.width=this.width,s.height=this.height,s.imgX=this.imgX,s.imgY=this.imgY,s.imgXscale=this.imgXscale,s.imgYscale=this.imgYscale,s.imgDegs=this.imgDegs,s.lorg=this.lorg,s},(Cango=function(t){if(this.cId=t,this.cnvs=document.getElementById(t),null!=this.cnvs){this.rawWidth=this.cnvs.offsetWidth,this.rawHeight=this.cnvs.offsetHeight,this.aRatio=this.rawWidth/this.rawHeight,this.buffered=!0,_resized.hasOwnProperty(this.cId)||(this.cnvs.setAttribute("width",this.rawWidth),this.cnvs.setAttribute("height",this.rawHeight),_resized[this.cId]=!0,this.buffered&&(_buf[this.cId]=document.createElement("canvas"),_buf[this.cId].setAttribute("width",this.rawWidth),_buf[this.cId].setAttribute("height",this.rawHeight)),_draggable[this.cId]=[],_overlays[this.cId]=[]),this.buffered&&(this.bufCtx=_buf[this.cId].getContext("2d")),this.ctx=this.cnvs.getContext("2d"),this.vpW=this.rawWidth,this.vpH=this.rawHeight,this.vpLLx=0,this.vpLLy=this.rawHeight,this.xscl=1,this.yscl=-1,this.xoffset=0,this.yoffset=0,this.ctx.textAlign="left",this.ctx.textBaseline="top",this.penCol="rgba(0, 0, 0, 1.0)",this.penWid=1,this.lineCap="butt",this.paintCol="rgba(128, 128, 128, 1.0)",this.fontSize=10,this.fontWeight=400,this.fontFamily="'Lucinda Console', monospace",this.animations=[],this.timer=null,this.modes={PAUSED:1,STOPPED:2,PLAYING:3,STEPPING:4},this.animMode=this.modes.STOPPED,this.prevAnimMode=this.modes.STOPPED,this.startTime=0,this.currTime=0,this.stepTime=50;var s=this;this.getUnique=function(){return o+=1},this.cnvs.onmousedown=function(t){function i(t){var i=s.cnvs.getBoundingClientRect();return{x:t.clientX-i.left,y:t.clientY-i.top}}function e(t){var i;if(s.ctx.beginPath(),"TEXT"==t.type||"IMG"==t.type)for(i=0;i<t.bBoxCmds.length;i++)s.ctx[t.bBoxCmds[i].drawFn].apply(s.ctx,t.bBoxCmds[i].parmsPx);else for(i=0;i<t.drawCmds.length;i++)s.ctx[t.drawCmds[i].drawFn].apply(s.ctx,t.drawCmds[i].parmsPx);return s.ctx.isPointInPath(o.x,o.y)}var r,o,a,h;for(r=t||window.event,o=i(r),h=_draggable[s.cId].length-1;h>=0;h--)if(e(a=_draggable[s.cId][h])&&a.dragNdrop){a.dragNdrop.grab(r);break}}}else alert("can't find canvas "+t)}).prototype.toViewportCoords=function(t,s){var i=this.vpLLx+this.xoffset+t*this.xscl,e=this.vpLLy+this.yoffset+s*this.yscl;return{x:100*i/this.rawWidth,y:100*(this.rawHeight-e)/this.rawWidth}},Cango.prototype.toPixelCoords=function(t,s){return{x:this.vpLLx+this.xoffset+t*this.xscl,y:this.vpLLy+this.yoffset+s*this.yscl}},Cango.prototype.toWorldCoords=function(t,s){return{x:(t-this.vpLLx-this.xoffset)/this.xscl,y:(s-this.vpLLy-this.yoffset)/this.yscl}},Cango.prototype.getCursorPosWC=function(t){var s=t||window.event,i=this.cnvs.getBoundingClientRect();return{x:(s.clientX-i.left-this.vpLLx-this.xoffset)/this.xscl,y:(s.clientY-i.top-this.vpLLy-this.yoffset)/this.yscl}},Cango.prototype.clearCanvas=function(t){t!=undefined?(this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.rawWidth,this.rawHeight)):this.ctx.clearRect(0,0,this.rawWidth,this.rawHeight),"sprite"!=this.cId&&(_draggable[this.cId].length=0)},Cango.prototype.setViewport=function(t,s,i,e){e&&i&&e>0&&i>0?(this.vpW=i*this.rawWidth/100,this.vpH=e*this.rawWidth/100,this.vpLLx=t*this.rawWidth/100,this.vpLLy=this.rawHeight-s*this.rawWidth/100):(this.vpW=this.rawWidth,this.vpH=this.rawHeight,this.vpLLx=0,this.vpLLy=this.rawHeight),this.setWorldCoords()},Cango.prototype.fillViewport=function(t){var s=this.paintCol;t!=undefined&&null!=t&&(s=t),this.ctx.save(),this.ctx.fillStyle=s,this.ctx.fillRect(this.vpLLx,this.vpLLy-this.vpH,this.vpW,this.vpH),this.ctx.restore()},Cango.prototype.setWorldCoords=function(t,s,i,e){var r=t||0,o=s||0;this.xscl=i&&i>0?this.vpW/i:1,this.yscl=e&&e>0?-this.vpH/e:-this.xscl,this.xoffset=-r*this.xscl,this.yoffset=-o*this.yscl},Cango.prototype.setPropertyDefault=function(t,s){if("string"==typeof t&&s!=undefined&&null!=s)switch(t.toLowerCase()){case"fillcolor":"string"!=typeof s&&"object"!=typeof s||(this.paintCol=s);break;case"strokecolor":"string"!=typeof s&&"object"!=typeof s||(this.penCol=s);break;case"strokewidth":this.penWid=s;break;case"linecap":"string"!=typeof s||"butt"!=s&&"round"!=s&&"square"!=s||(this.lineCap=s);break;case"fontfamily":"string"==typeof s&&(this.fontFamily=s);break;case"fontsize":this.fontSize=s;break;case"fontweight":("string"==typeof s||s>=100&&s<=900)&&(this.fontWeight=s);break;case"steptime":s>=15&&s<=500&&(this.stepTime=s);break;default:return}},Cango.prototype.linearGradientFill=function(t,s,i,e,r,o,a,h){var n,l,c,d,p=r||0,m=o||0,f=a||1,g=a||1;return h!=undefined&&"iso"==h&&(g*=-this.xscl/this.yscl),n=p+t*f,l=m+s*g,c=p+i*f,d=m+e*g,this.ctx.createLinearGradient(this.xscl*n,this.yscl*l,this.xscl*c,this.yscl*d)},Cango.prototype.radialGradientFill=function(t,s,i,e,r,o,a,h,n,l){var c,d,p,m,f,g,u=a||0,C=h||0,x=n||1,w=n||1;return l!=undefined&&"iso"==l&&(w*=-this.xscl/this.yscl),c=u+t*x,d=C+s*w,p=i*this.xscl*x,m=u+e*x,f=C+r*w,g=o*this.xscl*x,this.ctx.createRadialGradient(this.xscl*c,this.yscl*d,p,this.xscl*m,this.yscl*f,g)},Cango.prototype.render=function(t,s,i,e,r){function o(t,s,i,e,r){return function(){c._paintImg(t,s,i,e,r)}}function h(t){var s,i;if(a(t))for(s=0;s<t.length;s++)(i=t[s]).drawCmds!==undefined?d.push(i):a(i)&&h(i);else d.push(t)}var l,c=this,d=[];for(h(t),l=0;l<d.length;l++)"IMG"==d[l].type?d[l].width>0?this._paintImg(d[l],s,i,e,r):n(d[l].drawCmds,o(d[l],s,i,e,r)):"TEXT"==d[l].type?this._paintText(d[l],s,i,e,r):this._paintPath(d[l],s,i,e,r)},Cango.prototype._paintImg=function(t,s,i,e,r){function o(t,s){return[t*n-s*h,t*h+s*n]}var a,h,n,l,c,d=t.drawCmds,p=s||0,m=i||0,f=(e||1)*t.imgXscale,g=r||0;for(g+=t.imgDegs,this.ctx.save(),this.ctx.translate(this.vpLLx+this.xoffset+p*this.xscl,this.vpLLy+this.yoffset+m*this.yscl),g&&(a=g*Math.PI/180,h=Math.sin(a),n=Math.cos(a),this.ctx.rotate(-a)),this.ctx.drawImage(d,this.xscl*f*t.imgX,this.xscl*f*t.imgY,this.xscl*f*t.width,this.xscl*f*t.height),this.ctx.restore(),l=0;l<t.bBoxCmds.length-1;l++)c=g?o(t.bBoxCmds[l].parms[0],t.bBoxCmds[l].parms[1]):t.bBoxCmds[l].parms,t.bBoxCmds[l].parmsPx[0]=this.vpLLx+this.xoffset+c[0]*f*this.xscl+p*this.xscl,t.bBoxCmds[l].parmsPx[1]=this.vpLLy+this.yoffset-c[1]*f*this.xscl+m*this.yscl;t.dwgOrg.x=p,t.dwgOrg.y=m,null!=t.dragNdrop&&(_draggable[this.cId].contains(t)||_draggable[this.cId].push(t))},Cango.prototype._paintPath=function(t,s,i,e,r){var o,a,h,n,l,c,d,p,m,f,g=s||0,u=i||0,C=e||1,x=r||0,w=null,y=this.vpLLx+this.xoffset+g*this.xscl,b=this.vpLLy+this.yoffset+u*this.yscl,v=this.xscl,L=t.iso?-this.xscl:this.yscl;for(x&&(o=x*Math.PI/180,a=Math.sin(o),h=Math.cos(o)),this.ctx.save(),this.ctx.translate(y,b),this.ctx.scale(C,C),this.ctx.beginPath(),m=t.drawCmds.length,n=0;n<m;n++){for(f=t.drawCmds[n].parms.length,l=0;l<f;l+=2)d=t.drawCmds[n].parms[l],p=t.drawCmds[n].parms[l+1],x&&(c=d*a+p*h,d=d*h-p*a,p=c),t.drawCmds[n].parmsPx[l]=d*v,t.drawCmds[n].parmsPx[l+1]=p*L;this.ctx[t.drawCmds[n].drawFn].apply(this.ctx,t.drawCmds[n].parmsPx)}for("SHAPE"==t.type&&(w=t.fillCol instanceof Function?t.fillCol(arguments):t.fillCol,this.ctx.fillStyle=w,this.ctx.fill()),t.fillCol==t.strokeCol&&null!=w?this.ctx.strokeStyle=w:t.strokeCol instanceof Function?this.ctx.strokeStyle=t.strokeCol(arguments):this.ctx.strokeStyle=t.strokeCol,this.ctx.lineWidth=Math.abs(t.strokeWidth),this.ctx.lineCap=t.strokeCap,this.ctx.stroke(),this.ctx.restore(),n=0;n<m;n++)for(f=t.drawCmds[n].parms.length,l=0;l<f;l+=2)t.drawCmds[n].parmsPx[l]=t.drawCmds[n].parmsPx[l]*C+y,t.drawCmds[n].parmsPx[l+1]=t.drawCmds[n].parmsPx[l+1]*C+b;t.dwgOrg.x=g,t.dwgOrg.y=u,null!=t.dragNdrop&&(_draggable[this.cId].contains(t)||_draggable[this.cId].push(t))},Cango.prototype._paintText=function(t,s,i,e,r){function o(t,s){return[t*n-s*h,t*h+s*n]}var a,h,n,l,c,d=s||0,p=i||0,m=e||1,f=r||0;for(this.ctx.save(),this.ctx.translate(this.vpLLx+this.xoffset+d*this.xscl,this.vpLLy+this.yoffset+p*this.yscl),this.ctx.scale(m,m),this.ctx.save(),(f+=t.imgDegs)&&(a=f*Math.PI/180,h=Math.sin(a),n=Math.cos(a),this.ctx.rotate(-a)),this.ctx.font=t.fontWeight.toString()+" "+t.fontSize+"px "+this.fontFamily,t.strokeCol instanceof Function?this.ctx.fillStyle=t.strokeCol(arguments):this.ctx.fillStyle=t.strokeCol,this.ctx.fillText(t.drawCmds,t.imgX*this.xscl,t.imgY*this.yscl),this.ctx.restore(),this.ctx.restore(),l=0;l<t.bBoxCmds.length-1;l++)c=f?o(t.bBoxCmds[l].parms[0],t.bBoxCmds[l].parms[1]):t.bBoxCmds[l].parms,t.bBoxCmds[l].parmsPx[0]=this.vpLLx+this.xoffset+c[0]*m+d*this.xscl,t.bBoxCmds[l].parmsPx[1]=this.vpLLy+this.yoffset-c[1]*m+p*this.yscl;t.dwgOrg.x=d,t.dwgOrg.y=p,null!=t.dragNdrop&&(_draggable[this.cId].contains(t)||_draggable[this.cId].push(t))},Cango.prototype.compilePath=function(t,e,r,o,a){var h,n="iso"===a;return(h=new i(this,s(t,r||1),"PATH",n,null,e,null)).strokeWidth=o||this.penWid,h},Cango.prototype.compileShape=function(t,e,r,o,a){var h="iso"===a;return new i(this,s(t,o||1),"SHAPE",h,e,r,null)},Cango.prototype.compileText=function(s,e,r,o,a){var n,l,c,d,p,m,f,g,u,C=r||this.fontSize,x=a||1;if("string"==typeof s)return n=this.fontWeight,"string"==typeof o?n=o:h(o)&&o>99&&o<901&&(n=o),C*=1.3,this.ctx.save(),this.ctx.font=C+"px "+this.fontFamily,c=this.ctx.measureText(s).width,this.ctx.restore(),g=-(f=[0,[0,0],[p=c/2,0],[c,0],[0,m=(d=C)/2],[p,m],[c,m],[0,d],[p,d],[c,d]])[x][0],u=-f[x][1],(l=new i(this,s,"TEXT",!0,null,e,x)).imgX=g/this.xscl,l.imgY=u/this.yscl,l.width=c,l.height=d,l.fontSize=C,l.fontWeight=n,l.bBoxCmds[0]=new t("moveTo",[g,-u]),l.bBoxCmds[1]=new t("lineTo",[g,-u-d]),l.bBoxCmds[2]=new t("lineTo",[g+c,-u-d]),l.bBoxCmds[3]=new t("lineTo",[g+c,-u]),l.bBoxCmds[4]=new t("closePath",[]),l},Cango.prototype.compileImg=function(s,e,r){function o(){var s,i,r=e||h.drawCmds.width,o=r*h.drawCmds.height/h.drawCmds.width,n=r/2,l=o/2,c=[0,[0,0],[n,0],[r,0],[0,l],[n,l],[r,l],[0,o],[n,o],[r,o]];s=-c[a][0],i=-c[a][1],h.imgX=s,h.imgY=i,h.width=r,h.height=o,h.bBoxCmds[0]=new t("moveTo",[s,-i]),h.bBoxCmds[1]=new t("lineTo",[s,-i-o]),h.bBoxCmds[2]=new t("lineTo",[s+r,-i-o]),h.bBoxCmds[3]=new t("lineTo",[s+r,-i]),h.bBoxCmds[4]=new t("closePath",[])}var a=r||1,h=new i(this,new Image,"IMG",!0,null,null,a);if("string"==typeof s)return h.drawCmds.src="",n(h.drawCmds,o),h.drawCmds.src=s,h},Cango.prototype.drawPath=function(t,s,i,e,r,o){var a=this.compilePath(t,e,r,null,o);return this.render(a,s,i),a},Cango.prototype.drawShape=function(t,s,i,e,r,o){var a=this.compileShape(t,e,e,r,o);return this.render(a,s,i),a},Cango.prototype.drawText=function(t,s,i,e,r,o){var a=this.compileText(t,e,r,null,o);return this.render(a,s,i),a},Cango.prototype.drawImg=function(s,e,r,o,a){function h(){var s,i,e=o||m.drawCmds.width,r=e*m.drawCmds.height/m.drawCmds.width,a=e/2,h=r/2,n=[0,[0,0],[a,0],[e,0],[0,h],[a,h],[e,h],[0,r],[a,r],[e,r]];s=-n[p][0],i=-n[p][1],m.imgX=s,m.imgY=i,m.width=e,m.height=r,m.bBoxCmds[0]=new t("moveTo",[s,-i]),m.bBoxCmds[1]=new t("lineTo",[s,-i-r]),m.bBoxCmds[2]=new t("lineTo",[s+e,-i-r]),m.bBoxCmds[3]=new t("lineTo",[s+e,-i]),m.bBoxCmds[4]=new t("closePath",[]),l._paintImg(m,c,d,1,1,0)}var l=this,c=e||0,d=r||0,p=a||1,m=new i(this,new Image,"IMG",!0,null,null,p);return m.drawCmds.src="",n(m.drawCmds,h),m.drawCmds.src=s,m},Cango.prototype.clipPath=function(t){var s,i,e=[];if("IMG"!=this.type&&"TEXT"!=this.type){for(this.ctx.save(),this.ctx.beginPath(),s=0;s<t.drawCmds.length;s++){for(i=0;i<t.drawCmds[s].parms.length;i+=2)e[i]=this.vpLLx+this.xoffset+this.xscl*t.drawCmds[s].parms[i],t.iso?e[i+1]=this.vpLLy+this.yoffset-this.xscl*t.drawCmds[s].parms[i+1]:e[i+1]=this.vpLLy+this.yoffset+this.yscl*t.drawCmds[s].parms[i+1];this.ctx[t.drawCmds[s].drawFn].apply(this.ctx,e)}this.ctx.clip()}},Cango.prototype.resetClip=function(){this.ctx.restore()},Cango.prototype.createLayer=function(){var t,s,i,e,r,o=this.rawWidth,a=this.rawHeight,h=this.cnvs;return i=this.getUnique(),t="<canvas id='"+(e=this.cId+"_ovl_"+i)+"' style='position:absolute' width='"+o+"' height='"+a+"'></canvas>",_overlays[this.cId].length&&(r=_overlays[this.cId][_overlays[this.cId].length-1],h=document.getElementById(r)),h.insertAdjacentHTML("afterend",t),(s=document.getElementById(e)).style.backgroundColor="transparent",s.style.left=this.cnvs.offsetLeft+"px",s.style.top=this.cnvs.offsetTop+"px",s.style.width=this.cnvs.offsetWidth+"px",s.style.height=this.cnvs.offsetHeight+"px",_overlays[this.cId].push(e),e},Cango.prototype.deleteLayer=function(t){var s,i;-1!==(i=_overlays[this.cId].indexOf(t))&&((s=document.getElementById(t))&&s.parentNode.removeChild(s),_overlays[this.cId].splice(i,1))},Cango.prototype.dupCtx=function(t){this.vpLLx=t.vpLLx,this.vpLLy=t.vpLLy,this.xscl=t.xscl,this.yscl=t.yscl,this.xoffset=t.xoffset,this.yoffset=t.yoffset,this.penCol=t.penCol.slice(0),this.penWid=t.penWid,this.lineCap=t.lineCap.slice(0),this.paintCol=t.paintCol.slice(0),this.fontFamily=t.fontFamily.slice(0),this.fontSize=t.fontSize,this.fontWeight=t.fontWeight},Cango.prototype.animate=function(t,s,i,e,o,a,h,n){var l,c=!1;return n!=undefined&&"loop"==n&&(c=!0),(l=new r(t,s,i,e,o,a||0,h||0,c)).id=this.cId+"_"+this.getUnique(),this.animations.push(l),l.id},Cango.prototype.stopAnimation=function(){window.cancelAnimationFrame(this.timer),this.prevAnimMode=this.animMode,this.animMode=this.modes.STOPPED,this.currTime=0},Cango.prototype.pauseAnimation=function(){window.cancelAnimationFrame(this.timer),this.prevAnimMode=this.animMode,this.animMode=this.modes.PAUSED},Cango.prototype.stepAnimation=function(){function t(){var t,e,r,o,a=Date.now();for(s.prevAnimMode==s.modes.STOPPED&&(s.startTime=a),t=a-s.startTime,s.clearCanvas(),s.buffered&&(s.bufCtx.clearRect(0,0,s.rawWidth,s.rawHeight),r=s.ctx,s.ctx=s.bufCtx),o=0;o<s.animations.length;o++)(e=s.animations[o]).getState(t,i),s.render(e.obj,i.x,i.y,i.scl,i.rot);s.buffered&&(s.ctx=r,s.ctx.drawImage(_buf[s.cId],0,0)),s.currTime=t,s.prevAnimMode=s.modes.PAUSED,s.animMode=s.modes.PAUSED}var s=this,i={x:0,y:0,scl:1,rot:0};this.animMode!=this.modes.PLAYING&&(this.buffered&&(this.bufCtx.strokeStyle=this.penCol,this.bufCtx.fillStyle=this.paintCol,this.bufCtx.lineWidth=this.penWid,this.bufCtx.lineCap=this.lineCap),this.animMode==this.modes.PAUSED&&(this.startTime=Date.now()-this.currTime),this.prevAnimMode=this.animMode,this.animMode=this.modes.STEPPING,setTimeout(t,this.stepTime))},Cango.prototype.playAnimation=function(){function t(e){var r,o,a,h;e=Date.now();for(s.prevAnimMode==s.modes.STOPPED&&(s.startTime=e),r=e-s.startTime,s.clearCanvas(),s.buffered&&(s.bufCtx.clearRect(0,0,s.rawWidth,s.rawHeight),a=s.ctx,s.ctx=s.bufCtx),h=0;h<s.animations.length;h++)(o=s.animations[h]).getState(r,i),s.render(o.obj,i.x,i.y,i.scl,i.rot);s.buffered&&(s.ctx=a,s.ctx.drawImage(_buf[s.cId],0,0)),s.currTime=r,s.prevAnimMode=s.modes.PLAYING,s.timer=window.requestAnimationFrame(t)}var s=this,i={x:0,y:0,scl:1,rot:0};this.animMode!=this.modes.PLAYING&&(this.buffered&&(this.bufCtx.strokeStyle=this.penCol,this.bufCtx.fillStyle=this.paintCol,this.bufCtx.lineWidth=this.penWid,this.bufCtx.lineCap=this.lineCap),this.animMode==this.modes.PAUSED&&(this.startTime=Date.now()-this.currTime),this.prevAnimMode=this.animMode,this.animMode=this.modes.PLAYING,this.timer=window.requestAnimationFrame(t))},Cango.prototype.deleteAnimation=function(t){var s,i=-1;for(this.stopAnimation(),s=0;s<this.animations.length;s++)if(this.animations[s].id==t){i=s;break}-1!=i&&this.animations.splice(i,1)},Cango.prototype.deleteAllAnimations=function(){this.stopAnimation(),this.animations=[]},Cango.prototype.toImgObj=function(s){function e(){var s=x.drawCmds.width,i=x.drawCmds.height;x.imgX=l,x.imgY=c-i,x.width=s,x.height=i,x.bBoxCmds[0]=new t("moveTo",[l,-c+i]),x.bBoxCmds[1]=new t("lineTo",[l,-c]),x.bBoxCmds[2]=new t("lineTo",[l+s,-c]),x.bBoxCmds[3]=new t("lineTo",[l+s,-c+i]),x.bBoxCmds[4]=new t("closePath",[])}if("PATH"==s.type||"SHAPE"==s.type){var r,o,a,h,l,c,d,p,m,f,g=this.xscl,u=s.iso?-this.xscl:this.yscl,C={},x=new i(this,new Image,"IMG",!0);for(h=o=s.drawCmds[0].parms[0],a=r=s.drawCmds[0].parms[1],m=1;m<s.drawCmds.length;m++)for(f=0;f<s.drawCmds[m].parms.length;f+=2)s.drawCmds[m].parms[f]>o&&(o=s.drawCmds[m].parms[f]),s.drawCmds[m].parms[f]<h&&(h=s.drawCmds[m].parms[f]),s.drawCmds[m].parms[f+1]>r&&(r=s.drawCmds[m].parms[f+1]),s.drawCmds[m].parms[f+1]<a&&(a=s.drawCmds[m].parms[f+1]);return l=h*g-2,c=a*u+2,d=(o-h)*g+4,p=-(r-a)*u+4,C.width=d,C.height=p,C.buf=document.createElement("canvas"),C.buf.setAttribute("width",C.width),C.buf.setAttribute("height",C.height),C.gc={},C.gc.cId="sprite",C.gc.cnvs=C.buf,C.gc.ctx=C.gc.cnvs.getContext("2d"),C.gc.rawWidth=C.width,C.gc.rawHeight=C.height,C.gc.vpW=C.gc.rawWidth,C.gc.vpH=C.gc.rawHeight,C.gc.vpLLx=0,C.gc.vpLLy=C.gc.rawHeight,C.gc.xoffset=-l,C.gc.yoffset=-c,C.gc.xscl=this.xscl,C.gc.yscl=this.yscl,C.gc.penCol=this.penCol.slice(0),C.gc.penWid=this.penWid,C.gc.lineCap=this.lineCap.slice(0),C.gc.paintCol=this.paintCol.slice(0),this._paintPath.call(C.gc,s),x.drawCmds.src="",x.imgXscale=1/this.xscl,n(x.drawCmds,e),x.drawCmds.src=C.gc.cnvs.toDataURL(),x}},Drag2D=function(t,s,i,e){var r=this;this.cgo=t,this.parent=null,this.grabCallback=s||null,this.dragCallback=i||null,this.dropCallback=e||null,this.dwgOrg={x:0,y:0},this.grabOfs={x:0,y:0},this.grab=function(t){var s=t||window.event;this.dwgOrg=this.parent.dwgOrg,this.cgo.cnvs.onmouseup=function(t){r.drop(t)};var i=this.cgo.getCursorPosWC(s);return this.grabOfs={x:i.x-this.dwgOrg.x,y:i.y-this.dwgOrg.y},this.grabCallback&&this.grabCallback(i),this.cgo.cnvs.onmousemove=function(t){r.drag(t)},s.preventDefault?s.preventDefault():window.event.returnValue=!1,!1},this.drag=function(t){var s=this.cgo.getCursorPosWC(t);this.dragCallback&&this.dragCallback(s)},this.drop=function(t){var s=this.cgo.getCursorPosWC(t);this.cgo.cnvs.onmouseup=null,this.cgo.cnvs.onmousemove=null,this.dropCallback&&this.dropCallback(s)}},svgToCgo2D=function(t,s,i){function e(t,s,i,e,r){var o,a,h,n,l,c,d,p,m,f,g,u,C,x,w=0,y=0,b=[],v=e||1,L=r||v,T=s||0,k=i||0;for(C=0;C<t.length;C++){switch(g=(f=t[C])[0],0==C&&"M"!=g&&(g="M"),(x=f.slice(1))&&(x=x.map(parseFloat)),g){case"M":for(w=T+v*x[0],y=k+L*x[1],o=a=null,b.push("M",w,y),x.splice(0,2);x.length>0;)w=T+v*x[0],y=k+L*x[1],b.push("L",w,y),x.splice(0,2);break;case"m":for(w+=v*x[0],y+=L*x[1],o=a=null,b.push("M",w,y),x.splice(0,2);x.length>0;)w+=v*x[0],y+=L*x[1],b.push("L",w,y),x.splice(0,2);break;case"L":for(;x.length>0;)w=T+v*x[0],y=k+L*x[1],b.push("L",w,y),x.splice(0,2);o=a=null;break;case"l":for(;x.length>0;)w+=v*x[0],y+=L*x[1],b.push("L",w,y),x.splice(0,2);o=a=null;break;case"H":w=T+v*x[0],o=a=null,b.push("L",w,y);break;case"h":w+=v*x[0],o=a=null,b.push("L",w,y);break;case"V":y=k+L*x[0],o=a=null,b.push("L",w,y);break;case"v":y+=L*x[0],o=a=null,b.push("L",w,y);break;case"C":for(;x.length>0;)h=T+v*x[0],n=k+L*x[1],o=T+v*x[2],a=k+L*x[3],w=T+v*x[4],y=k+L*x[5],b.push("C",h,n,o,a,w,y),x.splice(0,6);break;case"c":for(;x.length>0;)h=w+v*x[0],n=y+L*x[1],o=w+v*x[2],a=y+L*x[3],w+=v*x[4],y+=L*x[5],b.push("C",h,n,o,a,w,y),x.splice(0,6);break;case"S":null!=o&&u.match(/[sc]/i)||(o=w,a=y),b.push("C",w-(o-w),y-(a-y),T+v*x[0],k+L*x[1],T+v*x[2],k+L*x[3]),o=T+v*x[0],a=k+L*x[1],w=T+v*x[2],y=k+L*x[3];break;case"s":null!=o&&u.match(/[sc]/i)||(o=w,a=y),b.push("C",w-(o-w),y-(a-y),w+T+v*x[0],y+k+L*x[1],w+T+v*x[2],y+k+L*x[3]),o=w+v*x[0],a=y+L*x[1],w+=v*x[2],y+=L*x[3];break;case"Q":o=T+v*x[0],a=k+L*x[1],w=T+v*x[2],y=k+L*x[3],b.push("Q",o,a,w,y);break;case"q":b.push("Q",[w+v*x[0],y+L*x[1],w+v*x[2],y+L*x[3]]),o=w+v*x[0],a=y+L*x[1],w+=v*x[2],y+=L*x[3];break;case"T":null!=o&&u.match(/[qt]/i)?(o=w-(o-w),a=y-(a-y)):(o=w,a=y),b.push("Q",o,a,T+v*x[0],k+L*x[1]),o=w-(o-w),a=y-(a-y),w=T+v*x[0],y=k+L*x[1];break;case"t":null!=o&&u.match(/[qt]/i)?(o=w-(o-w),a=y-(a-y)):(o=w,a=y),b.push("Q",o,a,w+v*x[0],y+L*x[1]),w+=v*x[0],y+=L*x[1];break;case"A":for(;x.length>0;)o=w,a=y,c=v*x[0],d=v*x[1],l=x[2],p=x[3],m=x[4],w=T+v*x[5],y=k+L*x[6],b.push("A",c,d,l,p,m,w,y),x.splice(0,7);break;case"a":for(;x.length>0;)o=w,a=y,c=v*x[0],d=v*x[1],l=x[2],p=x[3],m=x[4],w+=v*x[5],y+=L*x[6],b.push("A",c,d,l,p,m,w,y),x.splice(0,7);break;case"Z":case"z":b.push("Z")}u=g}return b}var r,o,a,h,n,l,c,d=[],p=1,m=-1,f=s||0,g=i||0;if("string"!=typeof t)return d;for(r=[],o=t.split(/(?=[a-df-z])/i),c=0;c<o.length;c++){if(!(n=(h=o[c]).match(/[a-z]/i)))return d;a=n.slice(0,1),0==c&&"M"!=a[0]&&(a[0]="M"),(l=h.match(/[\-\+]?[0-9]*\.?[0-9]+([eE][\-\+]?[0-9]+)?/gi))&&(l=l.map(parseFloat)),r.push(a.concat(l))}return d=e(r,f,-g,p,m)}}();